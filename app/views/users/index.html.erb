<% provide(:title, "BarCVVR") %>

<div class="row">
    <div class="col s7">
    <%= image_tag "Header.svg" %>
    </div>
  </div>

<div class="row">
  <div class="input-field col s6">
    <input placeholder="Chercher ..." type="text" onkeyup="Search()" id="Search">
  </div>
  <div class="input-field col s6">
    <button class="btn-floating btn-large waves-effect waves-light" onclick="window.scrollTo(0,document.body.scrollHeight);">
      <i class="material-icons">arrow_downward</i>
    </button>
  </div>
</div>

<table class="col s12 centered highlight striped" id="Table">
  <thead>
    <tr>
      <th>#</th>
      <th>Nom</th>
      <th>Prénom</th>
      <th>Surnom</th>
      <th>Compte</th>
      <th colspan="3"> Total : <%= @totalAmount %> </th>
    </tr>
  </thead>

  <tbody>
    <% i = 1 %>
    <% @operationLastMouth.each do |key, value| %>
      <tr>
        <td><%= i %></td>
        <td><%= @users.find(key).lastName %></td>
        <td><%= @users.find(key).firstName %></td>
        <td><%= @users.find(key).alias %></td>
        <td><%= @operationTotal[key] %></td>
        <td>
          <button class="btn-floating waves-effect green" onclick="window.location.href='/users/<%=@users.find(key).id%>'">
            <i class="material-icons">zoom_in</i>
          </button>
        </td>
        <td>
          <button class="btn-floating waves-effect amber" onclick="window.location.href='/operations/new?userid=<%=@users.find(key).id%>'">
            <%= image_tag "beer_glass.svg", height: "30", width: "30", style: 'margin-top: 5px' %>
          </button>
        </td>
        <td>
          <button class="btn-floating waves-effect light-blue" onclick="window.location.href='/operations/add?userid=<%=@users.find(key).id%>'">
            <i class="material-icons">euro_symbol</i>
          </button>
        </td>
      </tr>
      <% i = i + 1 %>
    <% end %>
  </tbody>
</table>

<br>

<button class="btn-floating btn-large waves-effect waves-light green" onclick="window.location.href='/users/new'">
  <i class="material-icons">add</i>
</button>

<button class="btn-floating btn-large waves-effect waves-light" onclick="window.location.href='/operations'">
  <i class="material-icons">cached</i>
</button>

<button class="btn-floating btn-large waves-effect waves-light amber" onclick="window.location.href='/drinks'">
  <%= image_tag "beer_glass.svg", height: "30", width: "30", style: 'margin-top: 12px' %>
  <i class="material-icons"     style="margin-left:10px; margin-top:10px;">add</i>
</button>

<button class="btn-floating btn-large waves-effect waves-light grey" onclick="window.location.href='/kegs'">
  <%= image_tag "beer_keg.svg", height: "30", width: "30", style: 'margin-top: 12px' %>
  <i class="material-icons" style="margin-left:10px; margin-top:10px;">add</i>
</button>

<br/>
<br/>
<br/>

<% @kegs.each do |keg| 
  opNum = 0
  operations = Operation.where("drink_id = ?", keg.drink_id).where("date > ?", keg.startDate)
  operations.each do |op|
    if op.numberDrink.to_s != ""
      opNum = opNum + op.numberDrink.to_s.to_d
    end
  end
  drink = Drink.find(keg.drink_id)
  if drink.drink_type == "Bière Cidre"
    volGlass = 0.3
  elsif drink.drink_type == "Vin"
    volGlass = 0.15
  elsif drink.drink_type == "Whisky Pastis Ricard Rhum"
    volGlass = 0.04
  else
    volGlass = 0
  end
  percent = 100-(100/(keg.capacity/volGlass)*opNum)
%>


<div class="chip">
   <%= image_tag "beer_keg.svg", style: "height: 25px !important; width: 25px !important; margin-top: 2px"%>
   <span style='position: relative; bottom: 3px'> <%= keg.name %> <%= Drink.find(keg.drink_id).name %> : <%= opNum.to_i %></span>
   <a href="/kegs/<%= keg.id %>/renew/" onclick="if (confirm('Voulez-vous changer le fût de <%= Drink.find(keg.drink_id).name %> ?') == true) {} else {return false;}"><i class="material-icons" style='position: relative; top: 3px'>cached</i></a>
   <div id="p1" style="width: 100%" class="progress" value="<%= opNum %>">
     <div class="determinate" style="width: <%= percent %>%;"></div>
   </div>
</div>

<% end %>

<script>
<% if notice %>
Materialize.toast('<%= notice %>', 4000) // 4000 is the duration of the toast
<% end %>

if (document.getElementById("Search").value.toUpperCase() != "") {
  Search();
}

function Search() {
  var input, filter, table, tr, td, i;
  input = document.getElementById("Search");
  filter = input.value.toUpperCase();
  table = document.getElementById("Table");
  tr = table.getElementsByTagName("tr");
  for (i = 0; i < tr.length; i++) {
    td0 = tr[i].getElementsByTagName("td")[0];
    if (td0) {
      if (td0.innerHTML.toUpperCase().indexOf(filter) > -1) {
        tr[i].style.display = "";
      } else {
        tr[i].style.display = "none";
        td1 = tr[i].getElementsByTagName("td")[1];
        if (td1) {
          if (td1.innerHTML.toUpperCase().indexOf(filter) > -1) {
            tr[i].style.display = "";
          } else {
            tr[i].style.display = "none";
            td2 = tr[i].getElementsByTagName("td")[2];
            if (td2) {
              if (td2.innerHTML.toUpperCase().indexOf(filter) > -1) {
                tr[i].style.display = "";
              } else {
                tr[i].style.display = "none";
                td3 = tr[i].getElementsByTagName("td")[3];
                if (td3) {
                  if (td3.innerHTML.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                  } else {
                    tr[i].style.display = "none";
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}
</script>
